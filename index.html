<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Localization QA Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body { background: #0b1020; color: #e7ecff; }
    .card { background: #141a33; border: 1px solid #232a4a; }
    .form-check-label { user-select: none; }
    .muted { color:#a4aed4; }
    .progress { background: #1a2140; }
    .progress-bar { background: #7c9bff; }
    .badge-chip { background:#1b2447; border:1px solid #2a3668; color:#cfe0ff; }
    a.link { color:#9ab0ff; text-decoration: underline; }
    table.table { color:#e7ecff; }
    table.table thead th { border-bottom: 1px solid #2a3668; }
    table.table td, table.table th { border-color:#2a3668; }
    .footer { font-size: 12px; color:#a4aed4; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center mb-3">
      <h2 class="me-3">Localization QA Checker</h2>
      <span class="badge badge-chip">Prototype 1 â€“ Beta</span>
    </div>
    <p class="muted">
      Upload an <strong>.xliff</strong>, pick checks, then run QA. AI checks consume API usage; use only when needed.
    </p>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card p-3">
          <h5 class="mb-3">1) Upload XLIFF</h5>
          <input id="fileInput" type="file" class="form-control" accept=".xliff,.xlf,application/xml" />
          <div id="fileName" class="mt-2 muted"></div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card p-3">
          <h5 class="mb-3">2) Select QA Parameters</h5>
          <div class="row">
            <div class="col-6">
              <div class="mb-2"><strong>Rule-based</strong></div>
              <div class="form-check">
                <input class="form-check-input rb" type="checkbox" value="tag_mismatch" id="rb1" checked>
                <label class="form-check-label" for="rb1">Tag mismatch</label>
              </div>
              <div class="form-check">
                <input class="form-check-input rb" type="checkbox" value="placeholder_mismatch" id="rb2" checked>
                <label class="form-check-label" for="rb2">Placeholder mismatch</label>
              </div>
              <div class="form-check">
                <input class="form-check-input rb" type="checkbox" value="spacing" id="rb3" checked>
                <label class="form-check-label" for="rb3">Extra/Missing spaces</label>
              </div>
              <div class="form-check">
                <input class="form-check-input rb" type="checkbox" value="punctuation" id="rb4">
                <label class="form-check-label" for="rb4">Punctuation mismatch</label>
              </div>
              <div class="form-check">
                <input class="form-check-input rb" type="checkbox" value="numbers" id="rb5" checked>
                <label class="form-check-label" for="rb5">Number/decimal mismatch</label>
              </div>
              <div class="form-check">
                <input class="form-check-input rb" type="checkbox" value="acronyms" id="rb6">
                <label class="form-check-label" for="rb6">Acronym mismatch</label>
              </div>
              <div class="form-check">
                <input class="form-check-input rb" type="checkbox" value="untranslated" id="rb7" checked>
                <label class="form-check-label" for="rb7">Untranslated segments</label>
              </div>
            </div>
            <div class="col-6">
              <div class="mb-2"><strong>AI-based</strong></div>
              <div class="form-check">
                <input class="form-check-input ai" type="checkbox" value="mistranslation" id="ai1" checked>
                <label class="form-check-label" for="ai1">Mistranslation / Meaning</label>
              </div>
              <div class="form-check">
                <input class="form-check-input ai" type="checkbox" value="grammar" id="ai2">
                <label class="form-check-label" for="ai2">Grammar</label>
              </div>
              <div class="form-check">
                <input class="form-check-input ai" type="checkbox" value="spelling_typos" id="ai3" checked>
                <label class="form-check-label" for="ai3">Spelling & Typos</label>
              </div>
              <div class="form-check">
                <input class="form-check-input ai" type="checkbox" value="tone_style" id="ai4">
                <label class="form-check-label" for="ai4">Tone / Style</label>
              </div>
              <div class="form-check">
                <input class="form-check-input ai" type="checkbox" value="locale" id="ai5">
                <label class="form-check-label" for="ai5">Locale formatting</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card p-3">
          <h5 class="mb-3">3) Run QA</h5>
          <button id="runBtn" class="btn btn-primary">Run QA</button>
          <span id="statusText" class="ms-3 muted">Idle</span>

          <div class="progress mt-3" style="height: 22px;">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card p-3">
          <h5 class="mb-3">Results</h5>
          <div id="resultsEmpty" class="muted">No results yet.</div>
          <div class="table-responsive" id="resultsWrap" style="display:none;">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="width:90px;">Segment ID</th>
                  <th>Source</th>
                  <th>Target</th>
                  <th>Issues</th>
                </tr>
              </thead>
              <tbody id="resultsBody"></tbody>
            </table>
          </div>
          <a id="downloadLink" class="btn btn-success mt-2" style="display:none;">Download Excel Report</a>
        </div>
      </div>
    </div>

    <div class="mt-4 footer">
      Note: This is a beta prototype; heavy files may be slower to process. Computation improvements are in progress.
    </div>
  </div>

  <script>
    const WEBHOOK_URL = "https://n8n-selfhosted-j9pv.onrender.com/webhook/qa-run"; // n8n Webhook Trigger path
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const runBtn = document.getElementById('runBtn');
    const statusText = document.getElementById('statusText');
    const progressBar = document.getElementById('progressBar');
    const resultsEmpty = document.getElementById('resultsEmpty');
    const resultsWrap = document.getElementById('resultsWrap');
    const resultsBody = document.getElementById('resultsBody');
    const downloadLink = document.getElementById('downloadLink');

    fileInput.addEventListener('change', () => {
      fileName.textContent = fileInput.files[0] ? `Selected: ${fileInput.files[0].name}` : "";
    });

    function getSelectedValues(cls) {
      return Array.from(document.querySelectorAll('.' + cls + ':checked'))
        .map(el => el.value);
    }

    function setProgress(p, msg) {
      progressBar.style.width = p + '%';
      progressBar.textContent = p + '%';
      statusText.textContent = msg;
    }

    function fakeProgressSequence() {
      const steps = [
        [10, "Uploading file..."],
        [25, "Parsing XLIFF..."],
        [45, "Running rule-based checks..."],
        [70, "Running AI checks..."],
        [85, "Generating Excel report..."]
      ];
      let idx = 0;
      const timer = setInterval(() => {
        if (idx < steps.length) {
          setProgress(steps[idx][0], steps[idx][1]);
          idx++;
        } else {
          clearInterval(timer);
        }
      }, 900);
      return timer;
    }

    function renderResults(issues) {
      resultsBody.innerHTML = '';
      if (!issues || !issues.length) {
        resultsEmpty.textContent = 'No issues found.';
        resultsWrap.style.display = 'none';
        resultsEmpty.style.display = '';
        return;
      }
      resultsEmpty.style.display = 'none';
      resultsWrap.style.display = '';
      issues.forEach(it => {
        const tr = document.createElement('tr');
        const issuesText = (it.issues || []).map(x => x.type + (x.details ? `: ${x.details}` : '')).join('; ');
        tr.innerHTML = `
          <td>${it.segmentId ?? ''}</td>
          <td>${(it.source ?? '').replace(/</g,'&lt;')}</td>
          <td>${(it.target ?? '').replace(/</g,'&lt;')}</td>
          <td>${issuesText || '-'}</td>
        `;
        resultsBody.appendChild(tr);
      });
    }

    function downloadBase64Excel(base64, filename) {
      const bytes = atob(base64);
      const buf = new ArrayBuffer(bytes.length);
      const arr = new Uint8Array(buf);
      for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
      const blob = new Blob([buf], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      const url = URL.createObjectURL(blob);
      downloadLink.href = url;
      downloadLink.download = filename || 'qa-report.xlsx';
      downloadLink.style.display = '';
    }

    runBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) {
        alert('Please choose an XLIFF file first.');
        return;
      }
      const rb = getSelectedValues('rb');
      const ai = getSelectedValues('ai');

      // Prepare request
      const form = new FormData();
      form.append('file', file);
      form.append('selectedRuleChecks', JSON.stringify(rb));
      form.append('selectedAiChecks', JSON.stringify(ai));

      downloadLink.style.display = 'none';
      resultsEmpty.style.display = '';
      resultsWrap.style.display = 'none';
      resultsEmpty.textContent = 'Waiting for results...';
      setProgress(0, 'Starting...');
      const timer = fakeProgressSequence();

      try {
        const res = await fetch(WEBHOOK_URL, { method: 'POST', body: form });
        const data = await res.json();

        clearInterval(timer);
        setProgress(100, 'Done');

        if (data && data.issues) {
          renderResults(data.issues);
        } else {
          resultsEmpty.textContent = 'No results received.';
        }

        if (data && data.report && data.report.base64 && data.report.filename) {
          downloadBase64Excel(data.report.base64, data.report.filename);
        }
      } catch (e) {
        clearInterval(timer);
        setProgress(100, 'Failed');
        console.error(e);
        resultsEmpty.textContent = 'Error: ' + (e?.message || 'Unknown error');
      }
    });
  </script>
</body>
</html>
